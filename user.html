<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Page</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
  <!-- Polyfills for IE8 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.10/es5-shim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.10/es5-sham.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="content">
      <h1>Welcome3</h1>
      <div class="user-display">
        <p id="username-display"></p>
        <p id="points-display">Points: 0</p>
      </div>
      <div class="input-name" style="display:none;">
        <input type="text" id="username-input" placeholder="Enter your name">
        <button id="save-button">Save</button>
      </div>
      <div class="input-purchase" style="display:none;">
        <input type="number" id="purchase-input" placeholder="Enter purchase amount">
        <button id="purchase-button">Purchase +</button>
        <div id="purchase-display"></div>
      </div>
      <div class="input-deduct" style="display:none;">
        <input type="number" id="deduct-input" placeholder="Enter points to deduct">
        <button id="deduct-button">Points -</button>
      </div>
    </div>
  </div>

  <script>
    // Polyfill for URLSearchParams in IE 8
    (function () {
      if ("URLSearchParams" in window) return;
  
      function URLSearchParams(query) {
        var params = {};
        query.replace(/(?:\?|&)?([^=&]+)=([^&]*)/g, function (_, key, value) {
          params[key] = decodeURIComponent(value.replace(/\+/g, " "));
        });
        this.get = function (key) { return params[key]; };
      }
  
      window.URLSearchParams = URLSearchParams;
    })();
  
    // Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyBRH_C6xo0LPOQavGXpf105nEdDjsgJ-g0",
      authDomain: "credit-d534b.firebaseapp.com",
      projectId: "credit-d534b",
      storageBucket: "credit-d534b.appspot.com",
      messagingSenderId: "886789683087",
      appId: "1:886789683087:web:d5ad542747600c3070fdfa"
    };
  
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
  
    window.onload = function() {
      var usernameDisplay = document.getElementById('username-display');
      var pointsDisplay = document.getElementById('points-display');
      var usernameInput = document.getElementById('username-input');
      var saveButton = document.getElementById('save-button');
      var purchaseInput = document.getElementById('purchase-input');
      var purchaseButton = document.getElementById('purchase-button');
      var deductInput = document.getElementById('deduct-input');
      var queryString = window.location.search;
      var urlParams = new URLSearchParams(queryString);
      var phoneNumber = urlParams.get('phone');
  
      // Check if user exists in Firestore
      function checkUserExists(phoneNumber, callback) {
        var userDocRef = db.collection('users').doc(phoneNumber);
        userDocRef.get().then(function(doc) {
          if (doc.exists) {
            callback(null, doc.data());
          } else {
            callback(null, null);
          }
        }).catch(function(error) {
          callback(error, null);
        });
      }
  
      // Display user name if user exists, else show input field
      function displayUserNameOrInput() {
        checkUserExists(phoneNumber, function(error, userData) {
          if (error) {
            alert("Error checking user: " + error);
            return;
          }
          if (userData && userData.name) {
            usernameDisplay.textContent = "Welcome, " + userData.name;
            document.getElementsByClassName('input-purchase')[0].style.display = "block";
            document.getElementsByClassName('input-deduct')[0].style.display = "block";
            updatePointsDisplay(userData.points || 0);
          } else {
            document.getElementsByClassName('input-name')[0].style.display = "block";
          }
        });
      }
  
      // Function to update the points display
      function updatePointsDisplay(points) {
        console.log(points);
        pointsDisplay.textContent = "Points: " + points;
      }
  
      // Event listener for Save button
      function saveButtonClickHandler() {
        var newName = usernameInput.value;
        if (newName.trim() !== '') {
          db.collection('users').doc(phoneNumber).set({
            name: newName,
            purchases: []
          }).then(function() {
            usernameDisplay.textContent = "Welcome, " + newName;
            document.getElementsByClassName('input-name')[0].style.display = "none";
            document.getElementsByClassName('input-purchase')[0].style.display = "block";
            updatePointsDisplay(0);
          }).catch(function(error) {
            alert("Error saving name: " + error);
          });
        } else {
          alert("Please enter a valid name.");
        }
      }
  
      // Event listener for Purchase button
      function purchaseButtonClickHandler() {
        var purchaseAmount = parseInt(purchaseInput.value, 10);
        if (!isNaN(purchaseAmount) && purchaseAmount > 0) {
          addPurchaseToDisplay(purchaseAmount);
          var userDocRef = db.collection('users').doc(phoneNumber);
          userDocRef.get().then(function(doc) {
            if (doc.exists) {
              var purchases = doc.data().purchases || [];
              purchases.push(purchaseAmount);
              originalPoints = doc.data().points || 0;
              originalPoints += purchaseAmount/20;
              userDocRef.update({
                points: originalPoints
              })
              userDocRef.update({
                purchases: purchases
              }).then(function() {
                alert("Purchase amount saved!");
                purchaseInput.value = '';
                updatePointsDisplay(originalPoints);
              }).catch(function(error) {
                alert("Error saving purchase amount: " + error);
              });
            } else {
              // Handle case when the document doesn't exist
            }
          }).catch(function(error) {
            alert("Error getting document: " + error);
          });
        } else {
          alert("Please enter a valid purchase amount.");
        }
      }

      function addPurchaseToDisplay(amount) {
        var purchaseDisplay = document.getElementById('purchase-display');
        var purchaseItem = document.createElement('div');
        purchaseItem.textContent = amount + " ";
        var deleteButton = document.createElement('button');
        deleteButton.textContent = "x";
        deleteButton.onclick = function() {
          removePurchaseFromDatabase(amount);
          purchaseItem.remove();
        };
        purchaseItem.appendChild(deleteButton);
        purchaseDisplay.appendChild(purchaseItem);
      }

      function removePurchaseFromDatabase(amount) {
        var userDocRef = db.collection('users').doc(phoneNumber);
        userDocRef.get().then(function(doc) {
          if (doc.exists) {
            var purchases = doc.data().purchases || [];
            var index = purchases.indexOf(amount);
            if (index !== -1) {
              purchases.splice(index, 1);
              var originalPoints = doc.data().points || 0;
              originalPoints -= amount / 20;
              userDocRef.update({
                points: originalPoints,
                purchases: purchases
              }).then(function() {
                updatePointsDisplay(originalPoints);
              }).catch(function(error) {
                alert("Error updating database: " + error);
              });
            }
          }
        }).catch(function(error) {
          alert("Error removing purchase from database: " + error);
        });
      }

      // Function to handle deduction of points
      function deductPoints() {
        var deductAmount = parseInt(deductInput.value, 10);
        if (!isNaN(deductAmount) && deductAmount > 0) {
          var userDocRef = db.collection('users').doc(phoneNumber);
          userDocRef.get().then(function(doc) {
            if (doc.exists) {
              var originalPoints = doc.data().points || 0;
              var updatedPoints = originalPoints - deductAmount;
              if (updatedPoints >= 0) {
                userDocRef.update({
                  points: updatedPoints
                }).then(function() {
                  updatePointsDisplay(updatedPoints);
                  deductInput.value = '';
                }).catch(function(error) {
                  alert("Error deducting points: " + error);
                });
              } else {
                alert("Insufficient points to deduct.");
              }
            } else {
              alert("User not found.");
            }
          }).catch(function(error) {
            alert("Error getting user document: " + error);
          });
        } else {
          alert("Please enter a valid amount of points to deduct.");
        }
      }

      // Attach event for Deduct button click
      var deductButton = document.getElementById('deduct-button');
      if (deductButton.attachEvent) {
        deductButton.attachEvent('onclick', deductPoints);
      } else {
        deductButton.addEventListener('click', deductPoints);
      }
  
      // Attach event for Save button click
      if (saveButton.attachEvent) {
        saveButton.attachEvent('onclick', saveButtonClickHandler);
      } else {
        saveButton.addEventListener('click', saveButtonClickHandler);
      }
  
      // Attach event for Purchase button click
      if (purchaseButton.attachEvent) {
        purchaseButton.attachEvent('onclick', purchaseButtonClickHandler);
      } else {
        purchaseButton.addEventListener('click', purchaseButtonClickHandler);
      }
  
      // Call the function to display user name or input field
      displayUserNameOrInput();
    }
  </script>
  
  
</body>
</html>
