<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Page</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js"></script>
</head>
<body>
  <div class="container">
    <div class="content">
      <h1>Welcome</h1>
      <div class="user-display">
        <p id="username-display"></p>
      </div>
      <div class="input-name" style="display:none;">
        <input type="text" id="username-input" placeholder="Enter your name">
        <button id="save-button">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Polyfill for IE 8 to support URLSearchParams
    (function () {
      if ("URLSearchParams" in window) return;

      function URLSearchParams(query) {
        var params = {};
        query.replace(/(?:\?|&)?([^=&]+)=([^&]*)/g, function (_, key, value) {
          params[key] = decodeURIComponent(value.replace(/\+/g, " "));
        });
        this.get = function (key) { return params[key]; };
      }

      window.URLSearchParams = URLSearchParams;
    })();

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBRH_C6xo0LPOQavGXpf105nEdDjsgJ-g0",
      authDomain: "credit-d534b.firebaseapp.com",
      projectId: "credit-d534b",
      storageBucket: "credit-d534b.appspot.com",
      messagingSenderId: "886789683087",
      appId: "1:886789683087:web:d5ad542747600c3070fdfa"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);

    window.onload = function() {
      var usernameDisplay = document.getElementById('username-display');
      var usernameInput = document.getElementById('username-input');
      var saveButton = document.getElementById('save-button');
      var queryString = window.location.search;
      var urlParams = new URLSearchParams(queryString);
      var phoneNumber = urlParams.get('phone');

      // Check if user exists in Firestore
      async function checkUserExists(phoneNumber) {
        const userDoc = await db.collection('users').doc(phoneNumber).get();
        return userDoc.exists ? userDoc.data().name : null;
      }

      // Display user name if user exists, else show input field
      async function displayUserNameOrInput() {
        const userName = await checkUserExists(phoneNumber);
        if (userName) {
          usernameDisplay.textContent = "Welcome, " + userName;
        } else {
          document.querySelector('.input-name').style.display = "block";
        }
      }

      // Event listener for Save button
      async function saveButtonClickHandler() {
        var newName = usernameInput.value;
        if (newName.trim() !== '') {
          await db.collection('users').doc(phoneNumber).set({
            name: newName
          });
          usernameDisplay.textContent = "Welcome, " + newName;
          document.querySelector('.input-name').style.display = "none";
        } else {
          alert("Please enter a valid name.");
        }
      }

      // Attach event for Save button click for IE 8
      if (saveButton.attachEvent) {
        saveButton.attachEvent('onclick', saveButtonClickHandler);
      } else {
        saveButton.addEventListener('click', saveButtonClickHandler);
      }

      // Call the function to display user name or input field
      displayUserNameOrInput();
    }
  </script>
</body>
</html>
